name: Daily Issue Close

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 11ì‹œ(UTC)ì— ì‹¤í–‰ (í•œêµ­ì‹œê°„ ë‹¤ìŒë‚  ì˜¤ì „ 8ì‹œ)
    - cron: '23 * * * *'
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì˜µì…˜

jobs:
  close-daily-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get yesterday's date
        id: date
        run: echo "yesterday=$(date -d 'yesterday' +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Find and close yesterday's daily issue
        uses: actions/github-script@v6
        with:
          script: |
            const yesterday = '${{ steps.date.outputs.yesterday }}';
            const searchTitle = `ğŸ“ Daily TIL - ${yesterday}`;
            
            // ì–´ì œì˜ ì´ìŠˆ ì°¾ê¸°
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'daily-til'
            });
            
            const dailyIssue = issues.data.find(issue => 
              issue.title.includes(yesterday)
            );
            
            if (dailyIssue) {
              // ì´ìŠˆ ì¢…ë£Œ
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: dailyIssue.number,
                state: 'closed'
              });
              
              // ì¢…ë£Œ ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: dailyIssue.number,
                body: `âœ… Daily learning log for ${yesterday} has been completed and closed.\n\n*This issue was automatically closed.*`
              });
              
              console.log(`âœ… Issue #${dailyIssue.number} closed: ${dailyIssue.title}`);
            } else {
              console.log(`â„¹ï¸ No open issue found for ${yesterday}`);
            }
